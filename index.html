<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventaire Technique</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: inline-block; width: 120px; margin-top: 10px; }
    input, button, textarea { margin: 5px; padding: 5px; }
    /* Réduction de moitié de la largeur des champs localisation, nombre et agent */
    #location, #quantity, #agent { width: 100px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
    img { max-width: 100px; max-height: 100px; }
    textarea { width: calc(100% - 150px); /* ajustement pour observation */ }
  </style>
</head>
<body>
  <h2>Inventaire Technique</h2>
  <form id="entryForm">
    <label for="building">Bâtiment :</label>
    <input id="building" required><br>
    <label for="location">Localisation :</label>
    <input id="location" required><br>
    <label for="title">Intitulé :</label>
    <input id="title" required><br>
    <label for="quantity">Nombre :</label>
    <input id="quantity" type="number" min="1" value="1" required><br>
    <label for="agent">Agent (initiales) :</label>
    <input id="agent" maxlength="5" placeholder="ex: JD" required><br>
    <label for="observations">Observations :</label>
    <textarea id="observations" maxlength="1000" rows="4" placeholder="Observations (max 1000 caractères)"></textarea><br>
    <label for="photo">Photo :</label>
    <input id="photo" type="file" accept="image/*"><br>
    <button type="button" id="addBtn">Ajouter</button>
    <button type="button" id="cancelBtn" style="display:none;">Annuler</button>
    <button type="button" id="backupBtn">Sauvegarde JSON</button>
    <button type="button" id="excelBtn">Export Excel</button>
    <button type="button" id="pdfBtn">Export PDF</button>
  </form>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Bâtiment</th>
        <th>Localisation</th>
        <th>Intitulé</th>
        <th>Nombre</th>
        <th>Agent</th>
        <th>Observations</th>
        <th>Photo</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Librairies externes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <!-- Script principal -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp,
      doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBpMuNgE7TSeGQOzJVEAxuJueXSyssoYAU",
      authDomain: "inventairetechnique.firebaseapp.com",
      projectId: "inventairetechnique",
      storageBucket: "inventairetechnique.appspot.com",
      messagingSenderId: "783866462106",
      appId: "1:783866462106:web:7bc5eca39df86773efc423"
    };

    // Initialisation
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM
    const form = document.getElementById("entryForm");
    const addBtn = document.getElementById("addBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const backupBtn = document.getElementById("backupBtn");
    const excelBtn = document.getElementById("excelBtn");
    const pdfBtn = document.getElementById("pdfBtn");
    const tbody = document.querySelector("#dataTable tbody");

    let editingId = null;

    addBtn.addEventListener("click", () => editingId ? saveEdit() : addEntry());
    cancelBtn.addEventListener("click", resetForm);
    backupBtn.addEventListener("click", backupJSON);
    excelBtn.addEventListener("click", exportToExcel);
    pdfBtn.addEventListener("click", exportToPDF);

    // Ajouter une entrée
    async function addEntry() {
      const entry = collectFormData();
      if (!entry) return;
      try {
        await addDoc(collection(db, "inventaire"), {
          ...entry,
          timestamp: serverTimestamp()
        });
        resetForm(); renderTable();
      } catch (e) {
        console.error("Erreur addEntry :", e);
        alert("Erreur lors de l'ajout : " + e.message);
      }
    }

    // Démarrer modification
    function startEdit(id, data) {
      editingId = id;
      document.getElementById("building").value = data.building;
      document.getElementById("location").value = data.location;
      document.getElementById("title").value = data.title;
      document.getElementById("quantity").value = data.quantity;
      document.getElementById("agent").value = data.agent;
      document.getElementById("observations").value = data.observations || "";
      addBtn.textContent = "Enregistrer";
      cancelBtn.style.display = "inline";
    }

    // Sauvegarder modification
    async function saveEdit() {
      const entry = collectFormData();
      if (!entry) return;
      try {
        const docRef = doc(db, "inventaire", editingId);
        await updateDoc(docRef, entry);
        resetForm(); renderTable();
      } catch (e) {
        console.error("Erreur saveEdit :", e);
        alert("Erreur lors de la modification : " + e.message);
      }
    }

    // Collecte et validation
    function collectFormData() {
      const building = document.getElementById("building").value.trim();
      const location = document.getElementById("location").value.trim();
      const title = document.getElementById("title").value.trim();
      const quantity = Number(document.getElementById("quantity").value);
      const agent = document.getElementById("agent").value.trim();
      const observations = document.getElementById("observations").value.trim();
      const photoInput = document.getElementById("photo");
      if (!building || !location || !title || quantity < 1 || !agent) {
        return alert("Tous les champs sauf observations et photo sont requis");
      }
      if (observations.length > 1000) {
        return alert("Les observations ne doivent pas dépasser 1000 caractères");
      }
      return { building, location, title, quantity, agent, observations };
    }

    // Réinitialiser formulaire
    function resetForm() {
      form.reset();
      editingId = null;
      addBtn.textContent = "Ajouter";
      cancelBtn.style.display = "none";
    }

    // Afficher la table
    async function renderTable() {
      tbody.innerHTML = "";
      try {
        const snapshot = await getDocs(query(
          collection(db, "inventaire"), orderBy("timestamp", "desc")
        ));
        snapshot.forEach(docItem => {
          const d = docItem.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.building}</td>
            <td>${d.location}</td>
            <td>${d.title}</td>
            <td>${d.quantity}</td>
            <td>${d.agent}</td>
            <td>${d.observations || ''}</td>
            <td>${d.photoURL ? `<img src=\"${d.photoURL}\">` : ""}</td>
            <td><button type=\"button\" onclick=\"startEdit('${docItem.id}', ${JSON.stringify(d)})\">Modifier</button></td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error("Erreur renderTable :", e);
        alert("Impossible de charger les données");
      }
    }

    // Sauvegarde JSON
    async function backupJSON() {
      try {
        const arr = [];
        const snapshot = await getDocs(collection(db, "inventaire"));
        snapshot.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
        const blob = new Blob([JSON.stringify(arr, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `inventaire_backup_${new Date().toISOString()}.json`;
        a.click();
      } catch (e) {
        console.error("Erreur backupJSON :", e);
        alert("Erreur lors de la sauvegarde JSON");
      }
    }

    // Export Excel
    async function exportToExcel() {
      try {
        let csv = "\uFEFFBâtiment,Localisation,Intitulé,Nombre,Agent,Observations,PhotoURL\n";
        const snapshot = await getDocs(collection(db, "inventaire"));
        snapshot.forEach(doc => {
          const d = doc.data();
          csv += `${d.building},${d.location},${d.title},${d.quantity},${d.agent},${d.observations},${d.photoURL}\n`;
        });
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "inventaire.csv";
        a.click();
      } catch (e) {
        console.error("Erreur exportToExcel :", e);
        alert("Erreur lors de l'export Excel");
      }
    }

    // Export PDF
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("Inventaire Technique", 10, 10);
      getDocs(collection(db, "inventaire")).then(snapshot => {
        const rows = [];
        snapshot.forEach(docItem => {
          const d = docItem.data();
          rows.push([
            d.building, d.location, d.title, d.quantity.toString(), d.agent, d.observations || '', d.photoURL
          ]);
        });
        doc.autoTable({ startY: 20,
          head: [["Bâtiment", "Localisation", "Intitulé", "Nombre", "Agent", "Observations", "PhotoURL"]],
          body: rows,
          styles: { fontSize: 10 }
        });
        doc.save("inventaire.pdf");
      }).catch(e => {
        console.error("Erreur exportToPDF :", e);
        alert("Erreur lors de l'export PDF");
      });
    }

    // Initialisation
    renderTable();  
    } 
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventaire Technique</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: inline-block; width: 120px; margin-top: 10px; }
    input, button { margin: 5px; padding: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
    img { max-width: 100px; max-height: 100px; }
  </style>
</head>
<body>
  <h2>Inventaire Technique</h2>
  <form id="entryForm">
    <label for="building">Bâtiment :</label>
    <input id="building" required><br>
    <label for="location">Localisation :</label>
    <input id="location" required><br>
    <label for="title">Intitulé :</label>
    <input id="title" required><br>
    <label for="quantity">Nombre :</label>
    <input id="quantity" type="number" min="1" value="1" required><br>
    <label for="agent">Agent (initiales) :</label>
    <input id="agent" maxlength="5" placeholder="ex: JD" required><br>
    <label for="photo">Photo :</label>
    <input id="photo" type="file" accept="image/*"><br>
    <button type="button" id="addBtn">Ajouter</button>
    <button type="button" id="backupBtn">Sauvegarde JSON</button>
    <button type="button" id="excelBtn">Export Excel</button>
    <button type="button" id="pdfBtn">Export PDF</button>
  </form>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Bâtiment</th>
        <th>Localisation</th>
        <th>Intitulé</th>
        <th>Nombre</th>
        <th>Agent</th>
        <th>Photo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Librairies externes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <!-- Script principal -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBpMuNgE7TSeGQOzJVEAxuJueXSyssoYAU",
      authDomain: "inventairetechnique.firebaseapp.com",
      projectId: "inventairetechnique",
      storageBucket: "inventairetechnique.appspot.com",
      messagingSenderId: "783866462106",
      appId: "1:783866462106:web:7bc5eca39df86773efc423"
    };

    // Initialisation
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM
    const form = document.getElementById('entryForm');
    const addBtn = document.getElementById('addBtn');
    const backupBtn = document.getElementById('backupBtn');
    const excelBtn = document.getElementById('excelBtn');
    const pdfBtn = document.getElementById('pdfBtn');
    const tbody = document.querySelector('#dataTable tbody');

    addBtn.addEventListener('click', addEntry);
    backupBtn.addEventListener('click', backupJSON);
    excelBtn.addEventListener('click', exportToExcel);
    pdfBtn.addEventListener('click', exportToPDF);

    // Ajouter une entrée
    async function addEntry() {
      const building = document.getElementById('building').value.trim();
      const location = document.getElementById('location').value.trim();
      const title = document.getElementById('title').value.trim();
      const quantity = Number(document.getElementById('quantity').value);
      const agent = document.getElementById('agent').value.trim();
      const photoInput = document.getElementById('photo');
      if (!building || !location || !title || quantity < 1 || !agent) {
        return alert('Tous les champs sont requis');
      }
      let photoURL = '';
      if (photoInput.files.length > 0) {
        const file = photoInput.files[0];
        if (file.size > 5 * 1024 * 1024) {
          return alert('La photo doit faire moins de 5 Mo');
        }
        const name = Date.now() + '_' + file.name;
        const ref = storageRef(storage, `photos/${name}`);
        try {
          await uploadBytes(ref, file);
          photoURL = await getDownloadURL(ref);
        } catch (e) {
          console.error('Erreur upload photo :', e);
          alert('Erreur lors de l'upload de la photo');
          return;
        }
      }
      try {
        await addDoc(collection(db, 'inventaire'), {
          building, location, title, quantity, agent, photoURL,
          timestamp: serverTimestamp()
        });
        form.reset(); renderTable();
      } catch (e) {
        console.error('Erreur addEntry :', e);
        alert('Erreur lors de l'ajout : ' + e.message);
      }
    }

    // Afficher la table
    async function renderTable() {
      tbody.innerHTML = '';
      try {
        const snapshot = await getDocs(query(
          collection(db, 'inventaire'), orderBy('timestamp', 'desc')
        ));
        snapshot.forEach(doc => {
          const d = doc.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${d.building}</td>
            <td>${d.location}</td>
            <td>${d.title}</td>
            <td>${d.quantity}</td>
            <td>${d.agent}</td>
            <td>${d.photoURL ? `<img src="${d.photoURL}">` : ''}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error('Erreur renderTable :', e);
        alert('Impossible de charger les données');
      }
    }

    // Sauvegarde JSON
    async function backupJSON() {
      try {
        const arr = [];
        const snapshot = await getDocs(collection(db, 'inventaire'));
        snapshot.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
        const blob = new Blob([JSON.stringify(arr, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `inventaire_backup_${new Date().toISOString()}.json`;
        a.click();
      } catch (e) {
        console.error('Erreur backupJSON :', e);
        alert('Erreur lors de la sauvegarde JSON');
      }
    }

    // Export Excel
    async function exportToExcel() {
      try {
        let csv = '\uFEFFBâtiment,Localisation,Intitulé,Nombre,Agent,PhotoURL\n';
        const snapshot = await getDocs(collection(db, 'inventaire'));
        snapshot.forEach(doc => {
          const d = doc.data();
          csv += `${d.building},${d.location},${d.title},${d.quantity},${d.agent},${d.photoURL}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'inventaire.csv';
        a.click();
      } catch (e) {
        console.error('Erreur exportToExcel :', e);
        alert('Erreur lors de l\'export Excel');
      }
    }

    // Export PDF
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text('Inventaire Technique', 10, 10);
      getDocs(collection(db, 'inventaire')).then(snapshot => {
        const rows = [];
        snapshot.forEach(doc => {
          const d = doc.data();
          rows.push([d.building, d.location, d.title, d.quantity.toString(), d.agent, d.photoURL]);
        });
        doc.autoTable({ startY: 20,
          head: [['Bâtiment', 'Localisation', 'Intitulé', 'Nombre', 'Agent', 'PhotoURL']],
          body: rows,
          styles: { fontSize: 10 }
        });
        doc.save('inventaire.pdf');
      }).catch(e => {
        console.error('Erreur exportToPDF :', e);
        alert('Erreur lors de l\'export PDF');
      });
    }

    // Initialisation
    renderTable();
  </script>
</body>
</html>
